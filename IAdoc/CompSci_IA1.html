<!DOCTYPE html>
<html>
<head>
	<title>Password Manager</title>

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	
	<!-- Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<link rel="stylesheet" type="text/css" href="CompSci_IA_CSS.css">

	<!-- Firebase-->
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
	

	<!-- AES Encryption in Javascript -->
	<script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
	
	<!-- Password to key -->
	<script src="https://raw.githubusercontent.com/ricmoo/scrypt-js/master/scrypt.js" type="text/javascript"></script>


	<!-- START OF CODE -->
	<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyBt71Qd9Y9B56iua99Khs41NQxthxuysXc",
		authDomain: "compsciia-f176a.firebaseapp.com",
		databaseURL: "https://compsciia-f176a.firebaseio.com",
		projectId: "compsciia-f176a",
		storageBucket: "compsciia-f176a.appspot.com",
		messagingSenderId: "567193459229"
	};
	firebase.initializeApp(config);


	//Initialize Firebase Database
	/*
	firebase.initializeApp({
		apiKey: 'AIzaSyBt71Qd9Y9B56iua99Khs41NQxthxuysXc',
		authDomain: 'compsciia-f176a.firebaseapp.com',
		projectId: 'compsciia-f176a'
	});

	*/

	// Initialize Cloud Firestore through Firebase
	var db = firebase.firestore();

	// Disable deprecated features
	db.settings({
		timestampsInSnapshots: true
	});
	

	//Sign out if already signed in
	signOut();
	

	//Create a user
	function createUser(email, password){
		firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
		// Handle Errors here.
		var errorCode = error.code;
		var errorMessage = error.message;
		// ...
		
		});
	}

	//Sign in an existing user
	function signIn(){
		var email = $("#email").val();
		var pwd = $("#pwd").val();
		console.log("trying to log in",email,pwd);
		firebase.auth().signInWithEmailAndPassword(email, pwd).catch(function(error) {
			// Handle Errors here.
			var errorCode = error.code;
			var errorMessage = "This is an error";
			// ...
		});
			
	}


	//Sign the user out
	function signOut(){
		firebase.auth().signOut().then(function() {
		// Sign-out successful.
		}).catch(function(error) {
		// An error happened.
		});
	}


	//Make it so the form isn't submitted when the Sign In button is clicked, but signIn() is run instead
	$(document).ready(function() {
		$("#button_signin").on("click", function(ev){ 
			console.log("login clicked");
			ev.preventDefault(); 
			signIn(); 
		});

	});


	//Do this when a user signs in
	var userId = null;
	firebase.auth().onAuthStateChanged(function(user) {
		if (user) {
			console.log("user signed in");
			document.getElementById("signin").style.display='none';
			document.getElementById("firstScreen").style.display='none';
			document.getElementById("intro").style.display='none';
			document.getElementById("intro").style.display='heading';
			document.getElementById("secondScreen").style.display='inline';
			document.getElementById("encryption_buttons").style.display='inline';

			var name = user.displayName;
			var email = user.email;
	
			
			var user = firebase.auth().currentUser;
			userId = user.uid;
			console.log(userId);
			
			/*
			db.collection("users").doc(userId).set({
				uid: userId,
				name: name,
				email: email,
				encrypted_data: "a335f0f7d74fd894f80f9108c62143d08f80f7c72be836720be895e5",
			})
			.then(function() {
				console.log("Document successfully written!");
			})
			.catch(function(error) {
				console.error("Error writing document: ", error);
			});
			*/

			var docRef = db.collection("users").doc(userId);

			docRef.get().then(function(doc) {
				if (doc.exists) {
					console.log("Document data:", doc.data());
					var docData = doc.data();
					console.log(docData);
					decrypt(docData.encrypted_data);

					//For all password entries, display those
					for (i = 0; i < passwords.length; i++){

						var table = document.getElementById('password_list');
						var row = table.insertRow(rowNumber);
						rowNumber++;
						var cell0 = row.insertCell(0);
						var cell1 = row.insertCell(1);
						var cell2 = row.insertCell(2);
						var cell3 = row.insertCell(3);
						var cell4 = row.insertCell(4);
						var cell5 = row.insertCell(5);
						cell0.innerHTML = passwords[i].name;
						cell1.innerHTML = passwords[i].website;
						cell2.innerHTML = passwords[i].password;
						cell3.innerHTML = currentDate;
						cell4.innerHTML = "<button class='btn btn-primary'>Change</button>";
						cell5.innerHTML = "<button class='btn btn-danger' onclick='deleteEntry(this)'>Remove</button>";

					}

					
					

				} else {
					// doc.data() will be undefined in this case
					console.log("No such document!");
				}
			}).catch(function(error) {
				console.log("Error getting document:", error);
			});
			
			


		} else {
		// No user is signed in.
		}
	});


	//PASSWORD LIST PART
	var passwords = [];

	//A variable that counts the number of rows (needed to know which position to add new rows to)
	var rowNumber = 0;

	//Gets the date in yyyy-mm-dd format, and puts it into any new password entries
	var date = new Date();
	var currentMonth = date.getMonth() + 1;
	var currentDate = date.getFullYear() + "-" + currentMonth + "-" + date.getDate();

	class passwordEntry {
		constructor(name, website, password) {
			this.name = name;
			this.website = website;
			this.password = password;
			this.dlc = currentDate;
		}
	}

	function addEntry(name, website, password){
			
		//backend --> adds the new entry to the array that is encrypted and stored
		var entry = new passwordEntry(name, website, password);
		passwords.push(entry);
		console.log(passwords);

		//frontend --> adds the new entry to the display
		var table = document.getElementById('password_list');
		var row = table.insertRow(rowNumber);
		rowNumber++;
		var cell0 = row.insertCell(0);
		var cell1 = row.insertCell(1);
		var cell2 = row.insertCell(2);
		var cell3 = row.insertCell(3);
		var cell4 = row.insertCell(4);
		var cell5 = row.insertCell(5);
		cell0.innerHTML = name;
		cell1.innerHTML = website;
		cell2.innerHTML = password;
		cell3.innerHTML = currentDate;
		cell4.innerHTML = "<button class='btn btn-primary'>Change</button>";
		cell5.innerHTML = "<button class='btn btn-danger' onclick='deleteEntry(this)'>Remove</button>";
	}

	function deleteEntry(r){
		var i = r.parentNode.parentNode.rowIndex;
		passwords.splice(i-1,1);
		document.getElementById('password_table').deleteRow(i);
		rowNumber--;
		console.log(passwords);

	}

	var stringPasswords = "";
		
		function stringifyPasswords(){
			stringPasswords = JSON.stringify(passwords);
			console.log(stringPasswords);
		}
		
		function parsePasswords(stringPass){
			passwords = JSON.parse(stringPass);
			console.log(passwords);
		}


	



	//encrypts the plaintext
	function encrypt() {

		//convert password objects in the array to a string
		stringifyPasswords();

		// An example 128-bit key (16 bytes * 8 bits/byte = 128 bits)
		var key = [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ];

		// Convert text to bytes
		var text = stringPasswords;
		var textBytes = aesjs.utils.utf8.toBytes(text);

		// The counter is optional, and if omitted will begin at 1
		var aesCtr = new aesjs.ModeOfOperation.ctr(key, new aesjs.Counter(5));
		var encryptedBytes = aesCtr.encrypt(textBytes);

		// To print or store the binary data, you may convert it to hex
		var encryptedHex = aesjs.utils.hex.fromBytes(encryptedBytes);
		console.log(encryptedHex);
		// "a338eda3874ed884b6199150d36f49988c90f5c47fe7792b0cf8c7f77eeffd87
		//  ea145b73e82aefcf2076f881c88879e4e25b1d7b24ba2788"
		//document.getElementById('a').innerHTML=encryptedHex;
		
		var docRef = db.collection("users").doc(userId);
		var setWithMerge = docRef.set({
			encrypted_data: encryptedHex
		}, { merge: true });

	

		docRef.get().then(function(doc) {
			if (doc.exists) {
				console.log("Document data:", doc.data());
				var docData = doc.data();
				console.log(docData);
				decrypt(docData.encrypted_data);


			} else {
				// doc.data() will be undefined in this case
				console.log("No such document!");
			}
		}).catch(function(error) {
			console.log("Error getting document:", error);
		});

	}
	
	//decrypts into plaintext
	function decrypt(input){
		var key = [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ];
		var encryptedBytes = aesjs.utils.hex.toBytes(input);
		
		// The counter mode of operation maintains internal state, so to
		// decrypt a new instance must be instantiated.
		var aesCtr = new aesjs.ModeOfOperation.ctr(key, new aesjs.Counter(5));
		var decryptedBytes = aesCtr.decrypt(encryptedBytes);

		// Convert our bytes back into text
		var decryptedText = aesjs.utils.utf8.fromBytes(decryptedBytes);
		console.log(decryptedText);
		// "Text may be any length you wish, no padding is required."
		//document.getElementById('decrypted_text').innerHTML=decryptedText;

		//convert string to an array with password objects
		parsePasswords(decryptedText);
	}
</script>
	
	<!-- end of working section -->

	
	
	
	<!-- These two libraries are highly recommended for encoding password/salt -->
    <script src="libs/buffer.js" type="text/javascript"></script> 
    <script src="libs/unorm.js" type="text/javascript"></script> 
 
    <!-- This shim library greatly improves performance of the scrypt algorithm -->
    <script src="libs/setImmediate.js" type="text/javascript"></script> 
 
    <script src="index.js" type="text/javascript"></script> 
    <script type="text/javascript">
 
      // See the section below: "Encoding Notes"
      var password = new buffer.SlowBuffer("anyPassword".normalize('NFKC'));
      var salt = new buffer.SlowBuffer("someSalt".normalize('NFKC'));
	
      var N = 1024, r = 8, p = 1;
      var dkLen = 32;
		
      scrypt(password, salt, N, r, p, dkLen, function(error, progress, key) {
        if (error) {
          console.log("Error: " + error);
 
        } else if (key) {
          console.log("Found: " + key);
 
        } else {
          // update UI with progress complete
          updateInterface(progress);
        }
      });
	  document.getElementById('output_key').innerHTML="partial success";
    </script> 

</head>


<body background="background1.jpg">
	<div>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
	  <ul class="navbar-nav">
		<li class="nav-item">
		  <a class="navbar-brand" href="#">OnlyPass</a>
		</li>
	  </ul>
	</nav>
	</div>

	
	
	<div id="firstScreen">
	<br>
	
	<div class="container main-window">
		
		<h1 id="heading" class="">One password, unlimited possibilities</h1>
		<br>
		<p id="intro" class="">Welcome to OnlyPass! Please sign in or create an account.</p>
	
	<br>
	<div class="container">
		<button id="register_main" class="btn btn-success" onclick="document.getElementById('register').style.display='block'">Create an account</button>
	</div>	
	
	<br><br>
	<div class="container">
		<button id="signin_main" class="btn btn-primary" onclick="document.getElementById('signin').style.display='block'">Sign in</button>
	</div>
	</div>
	</div>
	
	
	<!-- Create an account screen-->
	<div class="modal" id="register">
		<form class="modal-content animate" method="post" onsubmit="createUser(document.getElementById('email'),document.getElementById('pwd'));">
			<br>
			<div class="container">
				<div class="form-group">
				<label for="firstName">First Name:</label>
				<input type="text" class="form-control" id="firstName" required>
				</div>
				<div class="form-group">
				<label for="lastName">Last Name:</label>
				<input type="text" class="form-control" id="lastName">
				</div>
				<div class="form-group">
				<label for="dob">Date of birth:</label>
				<input type="date" class="form-control" id="dob" required>
				</div>
				<div class="form-group">
				<label for="email">Email address:</label>
				<input type="email" class="form-control" id="email2" required>
				</div>
				<div class="form-group">
				<label for="email">Confirm email address:</label>
				<input type="email" class="form-control" id="cemail" required>
				</div>
				<div class="form-group">
				<label for="pwd">Password:</label>
				<input type="password" class="form-control" id="pwd2" required>
				</div>
				<div class="form-group">
				<label for="pwd">Confirm password:</label>
				<input type="password" class="form-control" id="cpwd" required>
				</div>
				<div class="checkbox">
				<label><input type="checkbox" required> I have read the Terms and Conditions and agree to them.</label>
				</div>
				<div class="checkbox">
				<label><input type="checkbox"> You may send me occasional promotional material.</label>
				</div>
			</div>
			<br>

		<div style="background-color:#f1f1f1; padding: 16px;">
		  <button type="button" onclick="document.getElementById('register').style.display='none'" class="btn btn-danger">Cancel</button>
		  <button type="submit" style="float:right" class="btn btn-success">Create an account</button>
		</div>
		
	  </form>
	</div>

	<script>
		// Get the modal
		var modalRegister = document.getElementById('register');

		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
			if (event.target == modalRegister) {
				modalRegister.style.display = "none";
			}
		}
	</script>
	




	
	
	<!-- Sign in screen-->
	<div class="modal" id="signin">
		<form class="modal-content animate" method="post" onsubmit="signIn();">
			<br>
			<div class="container">
				<div class="form-group">
				<label for="email">Email address:</label>
				<input type="email" class="form-control" id="email" required>
				</div>
				<div class="form-group">
				<label for="pwd">Password:</label>
				<input type="password" class="form-control" id="pwd" required>
				</div>
				<div class="checkbox">
				<label><input type="checkbox"> Remember me</label>
				</div>
			</div>
			<br>

		<div style="background-color:#f1f1f1; padding: 16px;">
		  <button type="button" onclick="document.getElementById('signin').style.display='none'" class="btn btn-danger">Cancel</button>
		  <button type="button" style="float:right" class="btn btn-primary" id="button_signin">Sign in</button> 
		</div>
		
	  </form>
	</div>

	<!-- test -->
	<div id="test">

	</div> 

	<script>
		// Get the modal
		var modal = document.getElementById('signin');

		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
	</script>
	


	<!-- THIS SHOWS UP ONCE A USER IS SIGNED IN -->
	<div id="secondScreen" class="hidden">
		<table class="table" id="password_table">
			<thead class="thead-light">
			<tr>
				<th>Name</th>
				<th>Website</th>
				<th>Password</th>
				<th>Date last changed</th>
				<th></th>
			</tr>
			</thead>
			<tbody id="password_list">
			<tr>
				<td><input type="text" class="form-control" id="name01"></td>
				<td><input type="text" class="form-control" id="website01"></td>
				<td><input type="text" class="form-control" id="password01"></td>
				<td id='current_date'></td>
				<td><button class="btn btn-primary" onclick="addEntry(document.getElementById('name01').value, document.getElementById('website01').value, document.getElementById('password01').value);">Add</button></td>
			
			</tbody>
		</table> 
	</div>

	
	<div class="hidden container" id="encryption_buttons">
		<button class="btn btn-warning" onclick="encrypt();">Save</button>
	</div>


</body>
</html> 